# mayastor

Helm chart for mayastor

## Installation Guide

### Prerequisites

 - Make sure the [system requirement pre-requisites](https://mayastor.gitbook.io/introduction/quickstart/prerequisites) are met.
 - Label the nodes same as the mayastor.nodeSelector in values.yaml
 - Create the namespace you want the chart to be installed, or pass the `--create-namespace` flag in the `helm install` command.
   ```sh
   kubectl create ns <mayastor-namespace>
   ```
 - Create secret to download the images from private docker hub repo.
   ```sh
   kubectl create secret docker-registry <same-as-base.imagePullSecrets.secrets>  --docker-server="https://index.docker.io/v1/" --docker-username="<user-name>" --docker-password="<password>" --docker-email="<user-email>" -n <mayastor-namespace>
   ```

### Installing the chart

Clone the mayastor charts repo.
Sync the chart dependencies.
```sh
helm dependency update
```
Install the mayastor chart using the command
```sh
helm install mayastor . -n <mayastor-namespace>
```

### Documentation


# Mayastor


| Parameter                                                      | Description                                                                                                                                                                                                            | Default                                                            |
|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
| image.registry                                                 | image registry to pull Mayastor images                                                                                                                                                                                 | <code>docker.io</code>                                             |
| image.repo                                                     | image registry's namespace where all Mayastor images exist (default: openebs)                                                                                                                                         | <code>openebs</code>                                              |
| image.tag                                                      | release tag for OpenEBS Mayastor images                                                                                                                                                                                | <code>develop</code>                                               |
| image.pullPolicy                                               | imagePullPolicy for all Mayastor images                                                                                                                                                                                | <code>Always</code>                                                |
| nodeSelector                                                   | Node labels for pod assignment                                                                                                                                                                                         | <code>kubernetes.io/arch: amd64</code>                             |
| base.default_req_timeout                                       | request timeout for rest & core agents                                                                                                                                                                                 | <code>5s</code>                                                    |
| base.cache_poll_period                                         | cache timeout for core agent & diskpool deployment                                                                                                                                                                     | <code>30s</code>                                                   |
| base.initContainers.enabled                                    |                                                                                                                                                                                                                        | <code>true</code>                                                  |
| base.initCoreContainers.enabled                                |                                                                                                                                                                                                                        | <code>true</code>                                                  |
| base.imagePullSecrets.enabled                                  | enable imagePullSecrets for pulling Mayastor container images                                                                                                                                                          | <code>true</code>                                                  |
| base.metrics.enabled                                           | enable metrics exporter                                                                                                                                                                                                | <code>true</code>                                                  |
| base.metrics.pollingInterval                                   | metrics polling interval, lowering will adversely affect performance                                                                                                                                                   | <code>5m</code>                                                    |
| base.jaeger.enabled                                            | enable jaeger tracing                                                                                                                                                                                                  | <code>false</code>                                                 |
| base.jaeger.initContainer                                      |                                                                                                                                                                                                                        | <code>true</code>                                                  |
| base.jaeger.agent.name                                         |                                                                                                                                                                                                                        | <code>jaeger-agent</code>                                          |
| base.jaeger.agent.port                                         |                                                                                                                                                                                                                        | <code>6831</code>                                                  |
| base.initRestContainer.enabled                                 |                                                                                                                                                                                                                        | <code>true</code>                                                  |
| operators.pool.logLevel                                        | logLevel for mayastor diskpool operator & other dependent crate                                                                                                                                                        | <code>info,operator_diskpool=info</code>                           |
| operators.pool.resources.limits.cpu                            | cpu limits for diskpool operator                                                                                                                                                                                       | <code>"100m"</code>                                                |
| operators.pool.resources.limits.memory                         | memory limits for diskpool operator                                                                                                                                                                                    | <code>"32Mi"</code>                                                |
| operators.pool.resources.requests.cpu                          | cpu requests for diskpool operator                                                                                                                                                                                     | <code>"50m"</code>                                                 |
| operators.pool.resources.requests.memory                       | memory requests for diskpool operator                                                                                                                                                                                  | <code>"16Mi"</code>                                                |
| jaeger-operator.name                                           | name of jaeger operator                                                                                                                                                                                                | <code>"{{ .Release.Name }}"</code>                                 |
| jaeger-operator.crd.install                                    | install jaeger CRDs                                                                                                                                                                                                    | <code>false</code>                                                 |
| jaeger-operator.jaeger.create                                  | install jaeger-operator                                                                                                                                                                                                | <code>false</code>                                                 |
| jaeger-operator.rbac.clusterRole                               | create a clusterRole for Jaeger                                                                                                                                                                                        | <code>true</code>                                                  |
| agents.core.logLevel                                           | logLevel for the core crate                                                                                                                                                                                            | <code>info</code>                                                  |
| agents.core.resources.limits.cpu                               | cpu limits for core agents                                                                                                                                                                                             | <code>"1000m"</code>                                               |
| agents.core.resources.limits.memory                            | memory limits for core agents                                                                                                                                                                                          | <code>"32Mi"</code>                                                |
| agents.core.resources.requests.cpu                             | cpu requests for core agents                                                                                                                                                                                           | <code>"500m"</code>                                                |
| agents.core.resources.requests.memory                          | memory requests for core agents                                                                                                                                                                                        | <code>"16Mi"</code>                                                |
| apis.rest.logLevel                                             | logLevel for the rest crate                                                                                                                                                                                            | <code>info</code>                                                  |
| apis.rest.resources.limits.cpu                                 | cpu limits for rest                                                                                                                                                                                                    | <code>"100m"</code>                                                |
| apis.rest.resources.limits.memory                              | memory limits for rest                                                                                                                                                                                                 | <code>"64Mi"</code>                                                |
| apis.rest.resources.requests.cpu                               | cpu requests for rest                                                                                                                                                                                                  | <code>"50m"</code>                                                 |
| apis.rest.resources.requests.memory                            | memory requests for rest                                                                                                                                                                                               | <code>"32Mi"</code>                                                |
| csi.image.registry                                             | image registry to pull all CSI Sidecar images                                                                                                                                                                          | <code>registry.k8s.io</code>                                            |
| csi.image.repo                                                 | image registry's namespace                                                                                                                                                                                             | <code>sig-storage</code>                                           |
| csi.image.pullPolicy                                           | imagePullPolicy for all CSI Sidecar images                                                                                                                                                                             | <code>IfNotPresent</code>                                          |
| csi.image.provisionerTag                                       | csi-provisioner image release tag                                                                                                                                                                                      | <code>v2.2.1</code>                                                |
| csi.image.attacherTag                                          | csi-attacher image release tag                                                                                                                                                                                         | <code>v3.2.1</code>                                                |
| csi.image.registrarTag                                         | csi-node-driver-registrar image release tag                                                                                                                                                                            | <code>v2.1.0</code>                                                |
| csi.controller.logLevel                                        | logLevel for the csi controller                                                                                                                                                                                        | <code>info</code>                                                  |
| csi.controller.resources.limits.cpu                            | cpu limits for csi controller                                                                                                                                                                                          | <code>"32m"</code>                                                 |
| csi.controller.resources.limits.memory                         | memory limits for csi controller                                                                                                                                                                                       | <code>"128Mi"</code>                                               |
| csi.controller.resources.requests.cpu                          | cpu requests for csi controller                                                                                                                                                                                        | <code>"16m"</code>                                                 |
| csi.controller.resources.requests.memory                       | memory requests for csi controller                                                                                                                                                                                     | <code>"64Mi"</code>                                                |
| csi.node.logLevel                                              |                                                                                                                                                                                                                        | <code>info</code>                                                  |
| csi.node.resources.limits.cpu                                  | cpu limits for csi node plugin                                                                                                                                                                                         | <code>"100m"</code>                                                |
| csi.node.resources.limits.memory                               | memory limits for csi node plugin                                                                                                                                                                                      | <code>"128Mi"</code>                                               |
| csi.node.resources.requests.cpu                                | cpu requests for csi node plugin                                                                                                                                                                                       | <code>"100m"</code>                                                |
| csi.node.resources.requests.memory                             | memory requests for csi node plugin                                                                                                                                                                                    | <code>"64Mi"</code>                                                |
| csi.node.nvme.io_timeout                                       | nvme_core module io timeout in seconds                                                                                                                                                                                 | <code>"30"</code>                                                  |
| csi.node.nvme.ctrl_loss_tmo                                    | ctrl_loss_tmo (controller loss timeout) in seconds                                                                                                                                                                     | <code>"1980"</code>                                                |
| mayastor.logLevel                                              | logLevel for the core crate and other dependent crates                                                                                                                                                                 | <code>info,io_engine=info</code>                                   |
| mayastor.target.nvmf.iface                                     | NVMF target interface (ip, mac, name or subnet)                                                                                                                                                                        | <code>""</code>                                                    |
| mayastor.cpuCount                                              |                                                                                                                                                                                                                        | <code>"2"</code>                                                   |
| mayastor.nodeSelector.openebs.io/engine                        |                                                                                                                                                                                                                        | <code>io-engine</code>                                             |
| mayastor.nodeSelector.kubernetes.io/arch                       |                                                                                                                                                                                                                        | <code>amd64</code>                                                 |
| mayastor.resources.limits.cpu                                  | cpu limits for mayastor component                                                                                                                                                                                      | <code>""</code>                                                    |
| mayastor.resources.limits.memory                               | memory limits for mayastor component                                                                                                                                                                                   | <code>"1Gi"</code>                                                 |
| mayastor.resources.limits.hugepages2Mi                         | hugepage size available on the nodes                                                                                                                                                                                   | <code>"2Gi"</code>                                                 |
| mayastor.resources.requests.cpu                                | cpu requests for mayastor component                                                                                                                                                                                    | <code>""</code>                                                    |
| mayastor.resources.requests.memory                             | memory requests for csi node plugin                                                                                                                                                                                    | <code>"1Gi"</code>                                                 |
| mayastor.resources.requests.hugepages2Mi                       | hugepage size available on the nodes                                                                                                                                                                                   | <code>"2Gi"</code>                                                 |
| etcd.podLabels.app                                             |                                                                                                                                                                                                                        | <code>etcd</code>                                                  |
| etcd.podLabels.openebs.io/logging                              |                                                                                                                                                                                                                        | <code>"true"</code>                                                |
| etcd.replicaCount                                              | number of replicas of etcd                                                                                                                                                                                             | <code>3</code>                                                     |
| etcd.clusterDomain                                             | kubernetes Cluster Domain                                                                                                                                                                                              | <code>cluster.local</code>                                         |
| etcd.client.secureTransport                                    |                                                                                                                                                                                                                        | <code>false</code>                                                 |
| etcd.peer.secureTransport                                      |                                                                                                                                                                                                                        | <code>false</code>                                                 |
| etcd.persistence.enabled                                       | If true, use a Persistent Volume Claim. If false, use emptyDir.                                                                                                                                                        | <code>true</code>                                                  |
| etcd.persistence.storageClass                                  | storageClass will define which storageClass to use in etcd's StatefulSets a `manual` storageClass will provision a hostpath PV on the same node an empty storageClass will use the default StorageClass on the cluster | <code>""</code>                                                    |
| etcd.persistence.size                                          | etcd volume size                                                                                                                                                                                                       | <code>2Gi</code>                                                   |
| etcd.persistence.reclaimPolicy                                 | etcd's PVC's reclaimPolicy                                                                                                                                                                                             | <code>"Delete"</code>                                              |
| etcd.auth.rbac.enabled                                         |                                                                                                                                                                                                                        | <code>false</code>                                                 |
| etcd.auth.rbac.allowNoneAuthentication                         |                                                                                                                                                                                                                        | <code>true</code>                                                  |
| etcd.volumePermissions.enabled                                 | chown the mounted volume; this is required if a statically provisioned hostpath volume is used                                                                                                                         | <code>true</code>                                                  |
| etcd.debug                                                     | extra debug information on logs                                                                                                                                                                                        | <code>false</code>                                                 |
| etcd.initialClusterState                                       |                                                                                                                                                                                                                        | <code>"new"</code>                                                 |
| etcd.podAntiAffinityPreset                                     | Pod anti-affinity preset Ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity                                                                            | <code>"hard"</code>                                                |
| etcd.service.type                                              | K8s service type NOTE: Mayastor Supportability tool will work without any network workarounds(i.e port-forward) only if type is configured as NodePort                                                                 | <code>NodePort</code>                                              |
| etcd.service.port                                              | etcd client port                                                                                                                                                                                                       | <code>2379</code>                                                  |
| etcd.service.nodePorts.clientPort                              | Port from where etcd endpoints are accessible from outside cluster                                                                                                                                                     | <code>31379</code>                                                 |
| etcd.service.nodePorts.peerPort                                |                                                                                                                                                                                                                        | <code>""</code>                                                    |
| loki-stack.enabled                                             | enable loki log collection for Mayastor components                                                                                                                                                                     | <code>true</code>                                                  |
| loki-stack.loki.rbac.create                                    | create rbac roles for loki                                                                                                                                                                                             | <code>true</code>                                                  |
| loki-stack.loki.rbac.pspEnabled                                |                                                                                                                                                                                                                        | <code>false</code>                                                 |
| loki-stack.loki.enabled                                        | enable loki installation as part of loki-stack                                                                                                                                                                         | <code>true</code>                                                  |
| loki-stack.loki.persistence.enabled                            | enable persistence storage for the logs                                                                                                                                                                                | <code>true</code>                                                  |
| loki-stack.loki.persistence.storageClassName                   | storageClass for Loki's centralised log storage empty storageClass implies cluster default storageClass & `manual` creates a static hostpath PV                                                                        | <code>""</code>                                                    |
| loki-stack.loki.persistence.reclaimPolicy                      | loki pvc's ReclaimPolicy, can be Delete or Retain                                                                                                                                                                      | <code>"Delete"</code>                                              |
| loki-stack.loki.persistence.size                               | size of Loki's persistence storage                                                                                                                                                                                     | <code>10Gi</code>                                                  |
| loki-stack.loki.securityContext.fsGroup                        |                                                                                                                                                                                                                        | <code>1001</code>                                                  |
| loki-stack.loki.securityContext.runAsGroup                     |                                                                                                                                                                                                                        | <code>1001</code>                                                  |
| loki-stack.loki.securityContext.runAsNonRoot                   |                                                                                                                                                                                                                        | <code>false</code>                                                 |
| loki-stack.loki.securityContext.runAsUser                      |                                                                                                                                                                                                                        | <code>1001</code>                                                  |
| loki-stack.loki.config.compactor.compaction_interval           | Dictates how often compaction and/or retention is applied. If the Compactor falls behind, compaction and/or retention occur as soon as possible.                                                                       | <code>20m</code>                                                   |
| loki-stack.loki.config.compactor.retention_enabled             | If not enabled compactor will only compact table but they will not get deleted                                                                                                                                         | <code>true</code>                                                  |
| loki-stack.loki.config.compactor.retention_delete_delay        | The delay after which the compactor will delete marked chunks                                                                                                                                                          | <code>1h</code>                                                    |
| loki-stack.loki.config.compactor.retention_delete_worker_count | Specifies the maximum quantity of goroutine workers instantiated to delete chunks                                                                                                                                      | <code>50</code>                                                    |
| loki-stack.loki.config.limits_config.retention_period          | configuring retention period for logs                                                                                                                                                                                  | <code>168h</code>                                                  |
| loki-stack.loki.service.type                                   | K8s service type NOTE: Mayastor Supportability tool will work without any network workarounds only if type is configured as NodePort                                                                                   | <code>NodePort</code>                                              |
| loki-stack.loki.service.port                                   |                                                                                                                                                                                                                        | <code>3100</code>                                                  |
| loki-stack.loki.service.nodePort                               | Port where REST endpoints of Loki are accessible from outside cluster                                                                                                                                                  | <code>31001</code>                                                 |
| loki-stack.promtail.rbac.create                                | create rbac roles for promtail                                                                                                                                                                                         | <code>true</code>                                                  |
| loki-stack.promtail.rbac.pspEnabled                            |                                                                                                                                                                                                                        | <code>false</code>                                                 |
| loki-stack.promtail.enabled                                    | enabled enables promtail for scraping logs from nodes                                                                                                                                                                  | <code>true</code>                                                  |
| loki-stack.promtail.tolerations                                | Disallow promtail from running on the master node                                                                                                                                                                      | <code>[]</code>                                                    |
| loki-stack.promtail.config.lokiAddress                         | The Loki address to post logs to                                                                                                                                                                                       | <code>http://{{ .Release.Name }}-loki:3100/loki/api/v1/push</code> |
| loki-stack.promtail.config.snippets.scrapeConfigs              | Promtail will export logs to loki only based on based on below configuration, below scrape config will export only mayastor services which are labeled with openebs.io/logging=true                                    | ...                                                                |
| obs.callhome.enabled                                           | Enable callhome                                                                                                                                                                                                        | <code>true</code>                                                  |
| obs.callhome.log-level                                         | Log-level for callhome                                                                                                                                                                                                 | <code>"info"</code>                                                |
| obs.callhome.resources.limits.cpu                              | CPU limits for callhome                                                                                                                                                                                                | <code>"100m"</code>                                                |
| obs.callhome.resources.limits.memory                           | Memory limits for callhome                                                                                                                                                                                             | <code>"32Mi"</code>                                                |
| obs.callhome.resources.requests.cpu                            | CPU requests for callhome                                                                                                                                                                                              | <code>"50m"</code>                                                 |
| obs.callhome.resources.requests.memory                         | Memory requests for callhome                                                                                                                                                                                           | <code>"16Mi"</code>                                                |
